name: suwayomi

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "17 * * * *" # hourly

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - addon_dir: suwayomi_preview
            upstream_image: ghcr.io/suwayomi/suwayomi-server:preview
            upstream_tag: preview
            ghcr_image: ghcr.io/jipaix/ha-addons-suwayomi-preview
          - addon_dir: suwayomi_stable
            upstream_image: ghcr.io/suwayomi/suwayomi-server:stable
            upstream_tag: stable
            ghcr_image: ghcr.io/jipaix/ha-addons-suwayomi-stable

    steps:
      - uses: actions/checkout@v4

      - name: Install crane
        run: |
          curl -sSL https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz \
            | sudo tar -xz -C /usr/local/bin crane

      - name: Read upstream digest
        id: upstream
        run: |
          DIGEST="$(crane digest '${{ matrix.upstream_image }}')"
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "Upstream digest: $DIGEST"

      - name: Detect change
        id: cmp
        run: |
          FILE="${{ matrix.addon_dir }}/UPSTREAM_DIGEST"
          LAST="$(cat "$FILE" 2>/dev/null || true)"
          NEW="${{ steps.upstream.outputs.digest }}"
          if [ -n "$LAST" ] && [ "$LAST" = "$NEW" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "$NEW" > "$FILE"

      - name: Compute version
        if: steps.cmp.outputs.changed == 'true'
        run: |
          # version must match the image tag used by HA when 'image:' is set
          SHORT="$(echo '${{ steps.upstream.outputs.digest }}' | sed 's/.*://')"
          SHORT="${SHORT:0:12}"
          VER="${{ matrix.upstream_tag }}-$(date -u +'%Y%m%d-%H%M')-${SHORT}"
          echo "VER=$VER" >> $GITHUB_ENV

      - name: Bump add-on version in config.yaml
        if: steps.cmp.outputs.changed == 'true'
        run: |
          CFG="${{ matrix.addon_dir }}/config.yaml"
          sed -i "s/^version: \".*\"/version: \"$VER\"/" "$CFG"

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add "$CFG" "${{ matrix.addon_dir }}/UPSTREAM_DIGEST"
          git commit -m "chore(${{ matrix.addon_dir }}): bump to $VER" || exit 0

          # Avoid race between matrix jobs
          git pull --rebase origin main
          git push origin HEAD:main

      - name: Set up QEMU
        if: steps.cmp.outputs.changed == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        if: steps.cmp.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.cmp.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push multi-arch image
        if: steps.cmp.outputs.changed == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.addon_dir }}
          file: ${{ matrix.addon_dir }}/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            UPSTREAM_TAG=${{ matrix.upstream_tag }}
            BUILD_VERSION=${{ env.VER }}
            BUILD_ARCH=multi
          tags: |
            ${{ matrix.ghcr_image }}:${{ env.VER }}
            ${{ matrix.ghcr_image }}:${{ matrix.upstream_tag }}
