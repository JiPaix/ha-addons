name: suwayomi

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "17 * * * *" # hourly

concurrency:
  group: suwayomi-main
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install crane
        run: |
          curl -sSL https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz \
            | sudo tar -xz -C /usr/local/bin crane

      - name: Check upstream digests and bump versions if needed
        id: bump
        env:
          PREVIEW_DIR: suwayomi_preview
          STABLE_DIR: suwayomi_stable
          PREVIEW_UPSTREAM: ghcr.io/suwayomi/suwayomi-server:preview
          STABLE_UPSTREAM: ghcr.io/suwayomi/suwayomi-server:stable
        run: |
          set -euo pipefail

          changed_preview=false
          changed_stable=false
          ver_preview=""
          ver_stable=""

          bump_one() {
            local dir="$1"
            local upstream="$2"
            local tag="$3"
            local changed_var="$4"
            local ver_var="$5"

            local digest file last short ver
            digest="$(crane digest "$upstream")"
            file="${dir}/UPSTREAM_DIGEST"
            last="$(cat "$file" 2>/dev/null || true)"

            if [ -n "$last" ] && [ "$last" = "$digest" ]; then
              echo "No change for $dir ($digest)"
              eval "$changed_var=false"
              eval "$ver_var=''"
              return 0
            fi

            echo "Change detected for $dir: $last -> $digest"
            echo "$digest" > "$file"

            short="${digest#*:}"
            short="${short:0:12}"
            ver="${tag}-$(date -u +'%Y%m%d-%H%M')-${short}"

            # bump config.yaml
            sed -i "s/^version: \".*\"/version: \"${ver}\"/" "${dir}/config.yaml"

            eval "$changed_var=true"
            eval "$ver_var='${ver}'"
          }

          bump_one "$PREVIEW_DIR" "$PREVIEW_UPSTREAM" "preview" changed_preview ver_preview
          bump_one "$STABLE_DIR"  "$STABLE_UPSTREAM"  "stable"  changed_stable  ver_stable

          echo "changed_preview=$changed_preview" >> "$GITHUB_OUTPUT"
          echo "changed_stable=$changed_stable"   >> "$GITHUB_OUTPUT"
          echo "ver_preview=$ver_preview"         >> "$GITHUB_OUTPUT"
          echo "ver_stable=$ver_stable"           >> "$GITHUB_OUTPUT"

      - name: Commit and push bumps (single commit)
        if: steps.bump.outputs.changed_preview == 'true' || steps.bump.outputs.changed_stable == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          # stage only what may have changed
          git add suwayomi_preview/config.yaml suwayomi_preview/UPSTREAM_DIGEST \
                  suwayomi_stable/config.yaml  suwayomi_stable/UPSTREAM_DIGEST || true

          # if nothing staged, do nothing
          git diff --cached --quiet && exit 0

          msg="chore(suwayomi): bump"
          if [ "${{ steps.bump.outputs.changed_preview }}" = "true" ]; then
            msg="$msg preview=${{ steps.bump.outputs.ver_preview }}"
          fi
          if [ "${{ steps.bump.outputs.changed_stable }}" = "true" ]; then
            msg="$msg stable=${{ steps.bump.outputs.ver_stable }}"
          fi

          git commit -m "$msg"

          # rebase + push with retries (handles any concurrent manual pushes)
          for i in 1 2 3 4 5; do
            git fetch origin main
            git rebase origin/main || { git rebase --abort || true; exit 1; }
            if git push origin HEAD:main; then
              exit 0
            fi
            sleep $((i * 2))
          done

          exit 1

      - name: Set up QEMU
        if: steps.bump.outputs.changed_preview == 'true' || steps.bump.outputs.changed_stable == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        if: steps.bump.outputs.changed_preview == 'true' || steps.bump.outputs.changed_stable == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.bump.outputs.changed_preview == 'true' || steps.bump.outputs.changed_stable == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Preview build
      - name: Build & push preview (multi-arch)
        if: steps.bump.outputs.changed_preview == 'true'
        uses: docker/build-push-action@v6
        with:
          context: suwayomi_preview
          file: suwayomi_preview/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            UPSTREAM_TAG=preview
            BUILD_VERSION=${{ steps.bump.outputs.ver_preview }}
            BUILD_ARCH=multi
          tags: |
            ghcr.io/jipaix/ha-addons-suwayomi-preview:${{ steps.bump.outputs.ver_preview }}
            ghcr.io/jipaix/ha-addons-suwayomi-preview:preview

      # Stable build
      - name: Build & push stable (multi-arch)
        if: steps.bump.outputs.changed_stable == 'true'
        uses: docker/build-push-action@v6
        with:
          context: suwayomi_stable
          file: suwayomi_stable/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            UPSTREAM_TAG=stable
            BUILD_VERSION=${{ steps.bump.outputs.ver_stable }}
            BUILD_ARCH=multi
          tags: |
            ghcr.io/jipaix/ha-addons-suwayomi-stable:${{ steps.bump.outputs.ver_stable }}
            ghcr.io/jipaix/ha-addons-suwayomi-stable:stable
